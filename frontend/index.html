<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Р†РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–СЏ СЂРµСЃС‚РѕСЂР°РЅСѓ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 2em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    /* РњРѕРґР°Р»СЊРЅС– РІС–РєРЅР° */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    
    .modal-content h2 {
      margin-bottom: 20px;
      color: #333;
    }
    
    .modal-content input {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      border: 2px solid #ddd;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .modal-content input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .modal-content button {
      background: #667eea;
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .modal-content button:hover {
      background: #5568d3;
    }
    
    /* Р•РєСЂР°РЅ РІРёР±РѕСЂСѓ С…РѕР»РѕРґРёР»СЊРЅРёРєР° */
    #fridge-selector {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .fridge-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .fridge-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    .fridge-card.selected {
      background: #667eea;
      color: white;
    }
    
    .fridge-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }
    
    .fridge-number {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .fridge-count {
      font-size: 0.9em;
      opacity: 0.7;
    }
    
    /* РЎРїРёСЃРѕРє РїСЂРѕРґСѓРєС‚С–РІ */
    #product-list {
      display: none;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    #product-list.active {
      display: block;
    }
    
    .top-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .back-btn, .save-now-btn {
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s;
      font-weight: 500;
    }
    
    .back-btn {
      background: #667eea;
      flex: 1;
    }
    
    .back-btn:hover {
      background: #5568d3;
    }
    
    .save-now-btn {
      background: #f59e0b;
      flex: 2;
    }
    
    .save-now-btn:hover {
      background: #d97706;
    }
    
    /* РџРѕС€СѓРє */
    .search-box {
      margin: 20px 0;
      position: sticky;
      top: 0;
      background: white;
      padding: 10px 0;
      z-index: 100;
    }
    
    .search-input {
      width: 100%;
      padding: 15px 20px;
      font-size: 1.1em;
      border: 2px solid #ddd;
      border-radius: 10px;
      transition: border-color 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .search-stats {
      margin-top: 10px;
      color: #666;
      font-size: 0.9em;
      display: flex;
      justify-content: space-between;
    }
    
    .autosave-indicator {
      color: #10b981;
      font-size: 0.85em;
    }
    
    .product-item {
      border-bottom: 1px solid #eee;
      padding: 20px 0;
      display: grid;
      grid-template-columns: 1fr auto 150px;
      gap: 20px;
      align-items: center;
      transition: background 0.3s;
    }
    
    .product-item.hidden {
      display: none;
    }
    
    .product-item.highlight {
      background: #fffbeb;
      padding: 20px 10px;
      border-radius: 8px;
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-info h3 {
      font-size: 1.1em;
      margin-bottom: 5px;
      color: #333;
    }
    
    .product-info .category {
      font-size: 0.9em;
      color: #666;
      background: #f0f0f0;
      display: inline-block;
      padding: 3px 10px;
      border-radius: 5px;
      margin-right: 10px;
    }
    
    .product-info .type {
      font-size: 0.9em;
      color: #667eea;
      font-weight: 500;
    }
    
    .current-quantity {
      text-align: right;
      font-size: 0.9em;
      color: #666;
    }
    
    .quantity-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .quantity-input input {
      width: 100px;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      text-align: center;
      transition: border-color 0.3s;
    }
    
    .quantity-input input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .quantity-input input.filled {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .quantity-input input.error {
      border-color: #ef4444;
      background: #fef2f2;
    }
    
    .quantity-input span {
      color: #666;
      font-size: 0.9em;
    }
    
    .save-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      margin-top: 30px;
      width: 100%;
      transition: background 0.3s;
    }
    
    .save-btn:hover {
      background: #059669;
    }
    
    .save-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* РџСЂРѕРіСЂРµСЃ */
    .progress-bar {
      background: #f0f0f0;
      height: 8px;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #667eea, #764ba2);
      height: 100%;
      transition: width 0.3s;
    }
    
    .message {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
      font-weight: 500;
    }
    
    .message.success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .message.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .message.warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .message.info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 1.2em;
    }
    
    /* РњРѕРґР°Р»СЊРЅРµ РІС–РєРЅРѕ РґР»СЏ РЅРµР·Р°РїРѕРІРЅРµРЅРёС… РїРѕР·РёС†С–Р№ */
    .unfilled-modal {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .unfilled-list {
      text-align: left;
      margin: 20px 0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .unfilled-item {
      padding: 10px;
      background: #fef3c7;
      margin: 5px 0;
      border-radius: 5px;
      border-left: 4px solid #f59e0b;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .modal-buttons button {
      flex: 1;
    }
    
    .btn-secondary {
      background: #6b7280 !important;
    }
    
    .btn-secondary:hover {
      background: #4b5563 !important;
    }
    
    .error-text {
      color: #ef4444;
      font-size: 0.9em;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>вќ„пёЏ Р†РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–СЏ С…РѕР»РѕРґРёР»СЊРЅРёРєС–РІ</h1>
    
    <!-- РђРІС‚РѕСЂРёР·Р°С†С–СЏ -->
    <div id="auth-modal" class="modal active">
      <div class="modal-content">
        <h2>рџ”ђ РђРІС‚РѕСЂРёР·Р°С†С–СЏ</h2>
        <p style="color: #666; margin-bottom: 20px;">Р’РІРµРґС–С‚СЊ РєРѕРґ РґРѕСЃС‚СѓРїСѓ</p>
        <input type="password" id="auth-code" placeholder="РљРѕРґ РґРѕСЃС‚СѓРїСѓ" />
        <p id="auth-error" class="error-text" style="display: none;">РќРµРІС–СЂРЅРёР№ РєРѕРґ</p>
        <button onclick="checkAuth()">РЈРІС–Р№С‚Рё</button>
      </div>
    </div>
    
    <!-- РњРѕРґР°Р»СЊРЅРµ РІС–РєРЅРѕ РґР»СЏ РІРІРµРґРµРЅРЅСЏ РґР°С‚Рё -->
    <div id="date-modal" class="modal">
      <div class="modal-content">
        <h2>рџ“… Р”Р°С‚Р° С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–С—</h2>
        <p style="color: #666; margin-bottom: 20px;">Р’РІРµРґС–С‚СЊ РґР°С‚Сѓ РїСЂРѕРІРµРґРµРЅРЅСЏ С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–С—</p>
        <input type="date" id="inventory-date" />
        <button onclick="startInventory()">РџРѕС‡Р°С‚Рё С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–СЋ</button>
      </div>
    </div>
    
    <!-- РњРѕРґР°Р»СЊРЅРµ РІС–РєРЅРѕ РґР»СЏ РЅРµР·Р°РїРѕРІРЅРµРЅРёС… РїРѕР·РёС†С–Р№ -->
    <div id="unfilled-modal" class="modal">
      <div class="modal-content unfilled-modal">
        <h2>вљ пёЏ РќРµР·Р°РїРѕРІРЅРµРЅС– РїРѕР·РёС†С–С—</h2>
        <p style="color: #666; margin-bottom: 20px;">
          Р’Рё РЅРµ Р·Р°РїРѕРІРЅРёР»Рё РЅР°СЃС‚СѓРїРЅС– РїРѕР·РёС†С–С—. РџСЂРѕРґРѕРІР¶РёС‚Рё Р·Р±РµСЂРµР¶РµРЅРЅСЏ?
        </p>
        <div id="unfilled-list" class="unfilled-list"></div>
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="closeUnfilledModal()">РџРѕРІРµСЂРЅСѓС‚РёСЃСЊ</button>
          <button onclick="confirmSave()">Р—Р±РµСЂРµРіС‚Рё РІ Р±СѓРґСЊ-СЏРєРѕРјСѓ РІРёРїР°РґРєСѓ</button>
        </div>
      </div>
    </div>
    
    <div id="loading" class="loading">
      Р—Р°РІР°РЅС‚Р°Р¶РµРЅРЅСЏ РґР°РЅРёС…...
    </div>
    
    <!-- Р•РєСЂР°РЅ РІРёР±РѕСЂСѓ С…РѕР»РѕРґРёР»СЊРЅРёРєР° -->
    <div id="fridge-selector" style="display: none;"></div>
    
    <!-- Р•РєСЂР°РЅ СЃРїРёСЃРєСѓ РїСЂРѕРґСѓРєС‚С–РІ -->
    <div id="product-list">
      <div class="top-buttons">
        <button class="back-btn" onclick="showFridgeSelector()">в†ђ РќР°Р·Р°Рґ</button>
        <button class="save-now-btn" onclick="syncToGoogleSheets()">рџ”„ РЎРёРЅС…СЂРѕРЅС–Р·Р°С†С–СЏ</button>
      </div>
      <h2 id="current-fridge-title"></h2>
      
      <!-- РџРѕС€СѓРє -->
      <div class="search-box">
        <input 
          type="text" 
          class="search-input" 
          id="search-input" 
          placeholder="рџ”Ќ РџРѕС€СѓРє РїСЂРѕРґСѓРєС‚Сѓ (РЅР°РїСЂРёРєР»Р°Рґ: РєРѕРєР°, РїРёРІРѕ, СЃР°Р»Р°С‚...)"
          oninput="filterProducts()"
        />
        <div class="search-stats">
          <span id="search-stats-text"></span>
          <span class="autosave-indicator" id="autosave-indicator"></span>
        </div>
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <div id="message"></div>
      <div id="products-container"></div>
      <button class="save-btn" onclick="saveCurrentFridge()">вњ… Р—Р±РµСЂРµРіС‚Рё Р·Р°Р»РёС€РєРё С†СЊРѕРіРѕ С…РѕР»РѕРґРёР»СЊРЅРёРєР°</button>
    </div>
  </div>

  <script>
    const API_URL = "https://inventory-duab.onrender.com";
    const AUTH_CODE = "1234"; // Р—РјС–РЅС–С‚СЊ РЅР° РІР°С€ РєРѕРґ
    
    let allFridges = [];
    let currentFridge = null;
    let inventoryData = {};
    let inventoryDate = null;
    let currentProducts = [];
    let hasUnsavedChanges = false;
    let autosaveInterval = null;
    let isExistingInventory = false;

    // РџРµСЂРµРІС–СЂРєР° Р°РІС‚РѕСЂРёР·Р°С†С–С—
    function checkAuth() {
      const code = document.getElementById("auth-code").value;
      if (code === AUTH_CODE) {
        document.getElementById("auth-modal").classList.remove("active");
        document.getElementById("date-modal").classList.add("active");
        // Р’СЃС‚Р°РЅРѕРІР»СЋС”РјРѕ СЃСЊРѕРіРѕРґРЅС–С€РЅСЋ РґР°С‚Сѓ
        document.getElementById("inventory-date").valueAsDate = new Date();
      } else {
        document.getElementById("auth-error").style.display = "block";
      }
    }

    // Enter РґР»СЏ Р°РІС‚РѕСЂРёР·Р°С†С–С—
    document.getElementById("auth-code")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") checkAuth();
    });

    // РџРѕС‡Р°С‚РѕРє С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–С—
    async function startInventory() {
      const dateInput = document.getElementById("inventory-date").value;
      if (!dateInput) {
        alert("Р‘СѓРґСЊ Р»Р°СЃРєР°, РІРІРµРґС–С‚СЊ РґР°С‚Сѓ С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–С—");
        return;
      }
      
      inventoryDate = dateInput;
      document.getElementById("date-modal").classList.remove("active");
      
      // Р—Р°РІР°РЅС‚Р°Р¶СѓС”РјРѕ С‡РµСЂРЅРµС‚РєСѓ Р· localStorage
      loadDraft();
      
      // Р—Р°РІР°РЅС‚Р°Р¶СѓС”РјРѕ РґР°РЅС–
      await loadData();
      
      // Р—Р°РїСѓСЃРєР°С”РјРѕ Р°РІС‚РѕР·Р±РµСЂРµР¶РµРЅРЅСЏ
      startAutosave();
    }

    // Р—Р°РІР°РЅС‚Р°Р¶РµРЅРЅСЏ РґР°РЅРёС…
    async function loadData() {
      try {
        const response = await fetch(`${API_URL}/api/inventory/products?date=${inventoryDate}`);
        const result = await response.json();
        
        allFridges = result.data || result;
        isExistingInventory = result.existingInventory || false;
        
        if (isExistingInventory) {
          // РЇРєС‰Рѕ С–СЃРЅСѓС” С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–СЏ Р·Р° С†СЋ РґР°С‚Сѓ, Р·Р°РІР°РЅС‚Р°Р¶СѓС”РјРѕ Р·Р±РµСЂРµР¶РµРЅС– РґР°РЅС–
          allFridges.forEach(fridge => {
            inventoryData[fridge.fridgeNumber] = fridge.products.map(p => ({
              name: p.name,
              quantity: p.savedQuantity || ""
            }));
          });
          
          showMessage(`рџ“‹ Р—Р°РІР°РЅС‚Р°Р¶РµРЅРѕ С–СЃРЅСѓСЋС‡Сѓ С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–СЋ Р·Р° ${inventoryDate}`, "info");
        }
        
        document.getElementById("loading").style.display = "none";
        showFridgeSelector();
      } catch (error) {
        document.getElementById("loading").innerHTML = 
          `<div class="message error">вќЊ РџРѕРјРёР»РєР° Р·Р°РІР°РЅС‚Р°Р¶РµРЅРЅСЏ: ${error.message}</div>`;
      }
    }

    // РџРѕРєР°Р·Р°С‚Рё РїРѕРІС–РґРѕРјР»РµРЅРЅСЏ
    function showMessage(text, type = "success") {
      const messageDiv = document.getElementById("message");
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      setTimeout(() => {
        messageDiv.textContent = "";
        messageDiv.className = "message";
      }, 5000);
    }

    // РџРѕРєР°Р·Р°С‚Рё РµРєСЂР°РЅ РІРёР±РѕСЂСѓ С…РѕР»РѕРґРёР»СЊРЅРёРєС–РІ
    function showFridgeSelector() {
      document.getElementById("fridge-selector").style.display = "grid";
      document.getElementById("product-list").classList.remove("active");
      
      const selector = document.getElementById("fridge-selector");
      selector.innerHTML = "";
      
      allFridges.forEach(fridge => {
        const card = document.createElement("div");
        card.className = "fridge-card";
        
        const hasData = inventoryData[fridge.fridgeNumber] && 
                        inventoryData[fridge.fridgeNumber].some(p => p.quantity !== "");
        
        if (hasData) {
          card.classList.add("selected");
        }
        
        card.innerHTML = `
          <div class="fridge-icon">вќ„пёЏ</div>
          <div class="fridge-number">РҐРѕР»РѕРґРёР»СЊРЅРёРє ${fridge.fridgeNumber}</div>
          <div class="fridge-count">${fridge.products.length} РїРѕР·РёС†С–Р№</div>
          ${hasData ? '<div style="margin-top: 10px;">вњ… Р—Р°РїРѕРІРЅРµРЅРѕ</div>' : ''}
        `;
        
        card.onclick = () => showProducts(fridge);
        selector.appendChild(card);
      });
      
      if (Object.keys(inventoryData).length > 0) {
        const saveAllBtn = document.createElement("button");
        saveAllBtn.className = "save-btn";
        saveAllBtn.textContent = "вњ… РџСЂРѕРІРµСЃС‚Рё С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–СЋ";
        saveAllBtn.style.gridColumn = "1 / -1";
        saveAllBtn.onclick = checkAndSaveAll;
        selector.appendChild(saveAllBtn);
      }
    }

    // РџРѕРєР°Р·Р°С‚Рё РїСЂРѕРґСѓРєС‚Рё С…РѕР»РѕРґРёР»СЊРЅРёРєР°
    function showProducts(fridge) {
      currentFridge = fridge;
      currentProducts = fridge.products;
      document.getElementById("fridge-selector").style.display = "none";
      document.getElementById("product-list").classList.add("active");
      document.getElementById("current-fridge-title").textContent = 
        `РҐРѕР»РѕРґРёР»СЊРЅРёРє ${fridge.fridgeNumber}`;
      
      document.getElementById("search-input").value = "";
      
      const container = document.getElementById("products-container");
      container.innerHTML = "";
      
      const savedData = inventoryData[fridge.fridgeNumber] || [];
      
      fridge.products.forEach((product) => {
        const savedProduct = savedData.find(p => p.name === product.name);
        const quantity = savedProduct ? savedProduct.quantity : (product.savedQuantity || "");
        
        const item = document.createElement("div");
        item.className = "product-item";
        item.setAttribute("data-name", product.name.toLowerCase());
        item.setAttribute("data-category", product.category.toLowerCase());
        
        item.innerHTML = `
          <div class="product-info">
            <h3>${product.name}</h3>
            <span class="category">${product.category}</span>
            <span class="type">${product.type}</span>
          </div>
          <div class="current-quantity">
            ${product.currentQuantity && product.currentQuantity !== "0" ? `РџРѕС‚РѕС‡РЅРёР№: ${product.currentQuantity}` : ''}
          </div>
          <div class="quantity-input">
            <input 
              type="text" 
              placeholder="0 Р°Р±Рѕ 1+2"
              value="${quantity}"
              data-product-name="${product.name}"
              data-unit="${product.unit || 'РєРі'}"
              class="${quantity !== '' ? 'filled' : ''}"
              oninput="handleInput(this)"
              onblur="calculateExpression(this)"
            />
            <span>${product.unit || 'РєРі'}</span>
          </div>
        `;
        container.appendChild(item);
      });
      
      updateProgress();
      updateSearchStats();
    }

    // РћР±СЂРѕР±РєР° РІРІРµРґРµРЅРЅСЏ
    function handleInput(input) {
      hasUnsavedChanges = true;
      
      // РќРѕСЂРјР°Р»С–Р·Р°С†С–СЏ: Р·Р°РјС–РЅР° РєРѕРјРё РЅР° РєСЂР°РїРєСѓ
      let value = input.value.replace(/,/g, '.');
      
      // Р’РёРґР°Р»РµРЅРЅСЏ РїСЂРѕР±С–Р»С–РІ С‚Р° С‚РµРєСЃС‚Сѓ (РєРі, Рі, С‚.Рґ.)
      value = value.replace(/[^\d+\-*/().]/g, '');
      
      input.value = value;
      
      // Р’РёРґР°Р»РµРЅРЅСЏ РєР»Р°СЃСѓ РїРѕРјРёР»РєРё
      input.classList.remove("error");
      
      updateProgress();
      markAsFilled(input);
    }

    // РћР±С‡РёСЃР»РµРЅРЅСЏ РІРёСЂР°Р·С–РІ (1+2, 5+3.5)
    function calculateExpression(input) {
      const value = input.value.trim();
      
      if (value === "") {
        input.classList.remove("filled");
        return;
      }
      
      // РЇРєС‰Рѕ С” РјР°С‚РµРјР°С‚РёС‡РЅС– РѕРїРµСЂР°С‚РѕСЂРё, РѕР±С‡РёСЃР»СЋС”РјРѕ
      if (/[+\-*/]/.test(value)) {
        try {
          const result = eval(value);
          if (!isNaN(result) && isFinite(result)) {
            input.value = result.toFixed(2).replace(/\.?0+$/, '');
            input.classList.add("filled");
          } else {
            input.classList.add("error");
          }
        } catch (e) {
          input.classList.add("error");
        }
      } else {
        // РџРµСЂРµРІС–СЂРєР° С‡Рё С†Рµ С‡РёСЃР»Рѕ
        const num = parseFloat(value);
        if (isNaN(num)) {
          input.classList.add("error");
        } else {
          input.value = num.toString();
          input.classList.add("filled");
        }
      }
      
      updateProgress();
    }

    // РџРѕР·РЅР°С‡РёС‚Рё РїРѕР»Рµ СЏРє Р·Р°РїРѕРІРЅРµРЅРµ
    function markAsFilled(input) {
      if (input.value !== "") {
        input.classList.add("filled");
      } else {
        input.classList.remove("filled");
      }
    }

    // Р¤С–Р»СЊС‚СЂР°С†С–СЏ РїСЂРѕРґСѓРєС‚С–РІ
    function filterProducts() {
      const searchTerm = document.getElementById("search-input").value.toLowerCase();
      const items = document.querySelectorAll(".product-item");
      let visibleCount = 0;
      
      items.forEach(item => {
        const name = item.getAttribute("data-name");
        const category = item.getAttribute("data-category");
        
        if (name.includes(searchTerm) || category.includes(searchTerm)) {
          item.classList.remove("hidden");
          if (searchTerm !== "") {
            item.classList.add("highlight");
          } else {
            item.classList.remove("highlight");
          }
          visibleCount++;
        } else {
          item.classList.add("hidden");
          item.classList.remove("highlight");
        }
      });
      
      updateSearchStats(visibleCount, items.length);
    }

    // РћРЅРѕРІР»РµРЅРЅСЏ СЃС‚Р°С‚РёСЃС‚РёРєРё РїРѕС€СѓРєСѓ
    function updateSearchStats(visible, total) {
      const statsDiv = document.getElementById("search-stats-text");
      const searchTerm = document.getElementById("search-input").value;
      
      if (!total) {
        total = document.querySelectorAll(".product-item").length;
        visible = total;
      }
      
      if (searchTerm) {
        statsDiv.textContent = `Р—РЅР°Р№РґРµРЅРѕ: ${visible} Р· ${total} РїРѕР·РёС†С–Р№`;
      } else {
        statsDiv.textContent = `Р’СЃСЊРѕРіРѕ РїРѕР·РёС†С–Р№: ${total}`;
      }
    }

    // РћРЅРѕРІР»РµРЅРЅСЏ РїСЂРѕРіСЂРµСЃСѓ
    function updateProgress() {
      const inputs = document.querySelectorAll("#products-container input");
      const filled = Array.from(inputs).filter(input => input.value !== "").length;
      const total = inputs.length;
      const percent = (filled / total) * 100;
      
      document.getElementById("progress-fill").style.width = percent + "%";
    }

    // Р—Р±РµСЂРµРіС‚Рё РґР°РЅС– РїРѕС‚РѕС‡РЅРѕРіРѕ С…РѕР»РѕРґРёР»СЊРЅРёРєР°
    function saveCurrentFridge() {
      const inputs = document.querySelectorAll("#products-container input");
      const products = [];
      
      inputs.forEach(input => {
        const quantity = input.value;
        products.push({
          name: input.getAttribute("data-product-name"),
          quantity: quantity
        });
      });
      
      inventoryData[currentFridge.fridgeNumber] = products;
      hasUnsavedChanges = false;
      saveDraft();
      
      showMessage("вњ… Р”Р°РЅС– Р·Р±РµСЂРµР¶РµРЅРѕ! РњРѕР¶РµС‚Рµ РїРµСЂРµР№С‚Рё РґРѕ РЅР°СЃС‚СѓРїРЅРѕРіРѕ С…РѕР»РѕРґРёР»СЊРЅРёРєР°.", "success");
      
      setTimeout(() => {
        showFridgeSelector();
      }, 1500);
    }

    // РЎРёРЅС…СЂРѕРЅС–Р·Р°С†С–СЏ Р· Google Sheets (Р±РµР· Р·Р°РєСЂРёС‚С‚СЏ С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–С—)
    async function syncToGoogleSheets() {
      // РЎРїРѕС‡Р°С‚РєСѓ Р·Р±РµСЂС–РіР°С”РјРѕ РїРѕС‚РѕС‡РЅРёР№ С…РѕР»РѕРґРёР»СЊРЅРёРє Р»РѕРєР°Р»СЊРЅРѕ
      const inputs = document.querySelectorAll("#products-container input");
      const products = [];
      
      inputs.forEach(input => {
        const quantity = input.value;
        products.push({
          name: input.getAttribute("data-product-name"),
          quantity: quantity
        });
      });
      
      inventoryData[currentFridge.fridgeNumber] = products;
      saveDraft();
      
      // Р“РѕС‚СѓС”РјРѕ РґР°РЅС– РґР»СЏ РІС–РґРїСЂР°РІРєРё - С‚С–Р»СЊРєРё Р·Р°РїРѕРІРЅРµРЅС– РїРѕР·РёС†С–С—
      const fridgeArray = Object.keys(inventoryData).map(fridgeNumber => ({
        fridgeNumber,
        products: inventoryData[fridgeNumber]
          .filter(p => p.quantity !== "") // Р’С–РґС„С–Р»СЊС‚СЂРѕРІСѓС”РјРѕ РїРѕСЂРѕР¶РЅС–
          .map(p => ({
            name: p.name,
            quantity: parseFloat(p.quantity.replace(/,/g, '.')) || 0
          }))
      })).filter(f => f.products.length > 0); // РўС–Р»СЊРєРё С…РѕР»РѕРґРёР»СЊРЅРёРєРё Р· РґР°РЅРёРјРё
      
      try {
        showMessage("рџ”„ РЎРёРЅС…СЂРѕРЅС–Р·Р°С†С–СЏ Р· Google Sheets...", "info");
        
        const response = await fetch(`${API_URL}/api/inventory/save`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            inventoryData: fridgeArray,
            inventoryDate: inventoryDate
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage("вњ… РЎРёРЅС…СЂРѕРЅС–Р·РѕРІР°РЅРѕ Р· Google Sheets!", "success");
          hasUnsavedChanges = false;
        } else {
          showMessage("вќЊ РџРѕРјРёР»РєР° СЃРёРЅС…СЂРѕРЅС–Р·Р°С†С–С—: " + result.error, "error");
        }
      } catch (error) {
        showMessage("вќЊ РџРѕРјРёР»РєР° СЃРёРЅС…СЂРѕРЅС–Р·Р°С†С–С—: " + error.message, "error");
      }
    }

    // РџРµСЂРµРІС–СЂРєР° РЅРµР·Р°РїРѕРІРЅРµРЅРёС… РїРѕР·РёС†С–Р№
    function checkAndSaveAll() {
      const unfilled = [];
      
      Object.keys(inventoryData).forEach(fridgeNum => {
        inventoryData[fridgeNum].forEach(product => {
          if (product.quantity === "") {
            unfilled.push({
              fridge: fridgeNum,
              name: product.name
            });
          }
        });
      });
      
      if (unfilled.length > 0) {
        showUnfilledModal(unfilled);
      } else {
        saveAllInventory();
      }
    }

    // РџРѕРєР°Р·Р°С‚Рё РјРѕРґР°Р»СЊРЅРµ РІС–РєРЅРѕ РЅРµР·Р°РїРѕРІРЅРµРЅРёС…
    function showUnfilledModal(unfilled) {
      const modal = document.getElementById("unfilled-modal");
      const list = document.getElementById("unfilled-list");
      
      list.innerHTML = "";
      
      unfilled.forEach(item => {
        const div = document.createElement("div");
        div.className = "unfilled-item";
        div.textContent = `РҐРѕР»РѕРґРёР»СЊРЅРёРє ${item.fridge}: ${item.name}`;
        list.appendChild(div);
      });
      
      modal.classList.add("active");
    }

    // Р—Р°РєСЂРёС‚Рё РјРѕРґР°Р»СЊРЅРµ РІС–РєРЅРѕ
    function closeUnfilledModal() {
      document.getElementById("unfilled-modal").classList.remove("active");
    }

    // РџС–РґС‚РІРµСЂРґРёС‚Рё Р·Р±РµСЂРµР¶РµРЅРЅСЏ
    function confirmSave() {
      closeUnfilledModal();
      saveAllInventory();
    }

    // Р—Р±РµСЂРµРіС‚Рё РІСЃСЋ С–РЅРІРµРЅС‚Р°СЂРёР·Р°С†С–СЋ
    async function saveAllInventory() {
      try {
        // Р“РѕС‚СѓС”РјРѕ РґР°РЅС– - С‚С–Р»СЊРєРё Р·Р°РїРѕРІРЅРµРЅС– РїРѕР·РёС†С–С—
        const fridgeArray = Object.keys(inventoryData).map(fridgeNumber => ({
          fridgeNumber,
          products: inventoryData[fridgeNumber]
            .filter(p => p.quantity !== "") // Р’С–РґС„С–Р»СЊС‚СЂРѕРІСѓС”РјРѕ РїРѕСЂРѕР¶РЅС–
            .map(p => ({
              name: p.name,
              quantity: parseFloat(p.quantity.replace(/,/g, '.')) || 0
            }))
        })).filter(f => f.products.length > 0); // РўС–Р»СЊРєРё С…РѕР»РѕРґРёР»СЊРЅРёРєРё Р· РґР°РЅРёРјРё
        
        const response = await fetch(`${API_URL}/api/inventory/save`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            inventoryData: fridgeArray,
            inventoryDate: inventoryDate
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`вњ… ${result.message}\n\nРђСЂРєСѓС€: ${result.sheetName}`);
          inventoryData = {};
          inventoryDate = null;
          hasUnsavedChanges = false;
          clearDraft();
          stopAutosave();
          document.getElementById("date-modal").classList.add("active");
          document.getElementById("fridge-selector").style.display = "none";
        } else {
          alert("вќЊ РџРѕРјРёР»РєР°: " + result.error);
        }
      } catch (error) {
        alert("вќЊ РџРѕРјРёР»РєР° Р·Р±РµСЂРµР¶РµРЅРЅСЏ: " + error.message);
      }
    }

    // ============ РђР’РўРћР—Р‘Р•Р Р•Р–Р•РќРќРЇ ============
    
    function startAutosave() {
      autosaveInterval = setInterval(() => {
        saveDraft();
        showAutosaveIndicator();
      }, 5000); // РљРѕР¶РЅС– 5 СЃРµРєСѓРЅРґ
    }

    function stopAutosave() {
      if (autosaveInterval) {
        clearInterval(autosaveInterval);
      }
    }

    function saveDraft() {
      const draft = {
        inventoryData,
        inventoryDate,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem("inventory_draft", JSON.stringify(draft));
    }

    function loadDraft() {
      const draft = localStorage.getItem("inventory_draft");
      if (draft) {
        const data = JSON.parse(draft);
        if (data.inventoryDate === inventoryDate) {
          inventoryData = data.inventoryData;
          console.log("рџ“‹ Р—Р°РІР°РЅС‚Р°Р¶РµРЅРѕ С‡РµСЂРЅРµС‚РєСѓ Р· localStorage");
        }
      }
    }

    function clearDraft() {
      localStorage.removeItem("inventory_draft");
    }

    function showAutosaveIndicator() {
      const indicator = document.getElementById("autosave-indicator");
      indicator.textContent = "вњ“ РђРІС‚РѕР·Р±РµСЂРµР¶РµРЅРЅСЏ " + new Date().toLocaleTimeString();
      setTimeout(() => {
        indicator.textContent = "";
      }, 3000);
    }

    // РџРѕРїРµСЂРµРґР¶РµРЅРЅСЏ РїРµСЂРµРґ РІРёС…РѕРґРѕРј
    window.addEventListener("beforeunload", (e) => {
      if (hasUnsavedChanges || Object.keys(inventoryData).length > 0) {
        e.preventDefault();
        e.returnValue = "Р’Р°С€С– Р·РјС–РЅРё РјРѕР¶СѓС‚СЊ Р±СѓС‚Рё РІС‚СЂР°С‡РµРЅС–. Р’РёР№С‚Рё РІСЃРµ РѕРґРЅРѕ?";
        return e.returnValue;
      }
    });
  </script>
</body>
</html>
