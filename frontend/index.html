<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è</title>
  <style>
    /* ... –°—Ç–∏–ª—ñ –∑–∞–ª–∏—à–∞—î–º–æ —Ç—ñ —Å–∞–º—ñ ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .product-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    .quantity-input input { width: 80px; padding: 8px; font-size: 16px; text-align: center; }
    .quantity-input input.filled { background-color: #e6fffa; border-color: #38b2ac; }
    /* –î–æ–¥–∞–π —Å–≤–æ—ó —Å—Ç–∏–ª—ñ —Å—é–¥–∏ */
    #fridge-selector, #product-list { display: none; }
    #fridge-selector.active, #product-list.active { display: block; }
    .fridge-card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; cursor: pointer; text-align: center; border: 1px solid #ddd; }
    .fridge-card.selected { border-color: #3182ce; background: #ebf8ff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì¶ –Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è</h1>
    
    <div id="date-selector">
        <input type="date" id="inventory-date" style="padding: 10px; font-size: 16px;">
        <button onclick="startInventory()" style="padding: 10px;">–ü–æ—á–∞—Ç–∏</button>
    </div>

    <div id="fridge-selector"></div>
    
    <div id="product-list">
      <button onclick="showFridgeSelector()">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫—ñ–≤</button>
      <h2 id="current-fridge-title"></h2>
      <div id="products-container"></div>
      <button onclick="saveCurrentFridge()" style="width:100%; padding:15px; background:#48bb78; color:white; border:none; margin-top:20px; font-size:18px;">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ü–µ–π —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</button>
    </div>
  </div>

  <script>
    const API_URL = "https://inventory-duab.onrender.com"; // –ê–±–æ —Ç–≤–æ—è URL
    
    let allFridges = [];
    let currentFridge = null;
    let inventoryData = {};
    let inventoryDate = null;

    async function startInventory() {
      const dateInput = document.getElementById("inventory-date").value;
      if (!dateInput) return alert("–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É");
      
      inventoryDate = dateInput;
      
      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞ (–≤–∫–ª—é—á–∞—é—á–∏ —Ç—ñ, —â–æ –≤–∂–µ –±—É–ª–∏ –≤–≤–µ–¥–µ–Ω—ñ —Ä–∞–Ω—ñ—à–µ!)
      try {
        const res = await fetch(`${API_URL}/api/inventory/products?date=${inventoryDate}`);
        const result = await res.json();
        
        allFridges = result.data;
        
        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ —Ç–∏–º, —â–æ –ø—Ä–∏–π—à–ª–æ –∑ —Å–µ—Ä–≤–µ—Ä–∞
        allFridges.forEach(fridge => {
          // –Ø–∫—â–æ —î savedQuantity, –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –π–æ–≥–æ, —ñ–Ω–∞–∫—à–µ ""
          inventoryData[fridge.fridgeNumber] = fridge.products.map(p => ({
            name: p.name,
            quantity: p.savedQuantity !== undefined ? p.savedQuantity : ""
          }));
        });

        document.getElementById("date-selector").style.display = "none";
        showFridgeSelector();
        
      } catch (e) {
        alert("–ü–æ–º–∏–ª–∫–∞: " + e.message);
      }
    }

    function showFridgeSelector() {
      document.getElementById("product-list").classList.remove("active");
      const selector = document.getElementById("fridge-selector");
      selector.className = "active";
      selector.innerHTML = "";
      
      allFridges.forEach(fridge => {
        const card = document.createElement("div");
        card.className = "fridge-card";
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –¥–∞–Ω—ñ —Å–∞–º–µ —É –Ω–∞—Å –≤ –ø–∞–º'—è—Ç—ñ
        const hasData = inventoryData[fridge.fridgeNumber] && 
                        inventoryData[fridge.fridgeNumber].some(p => p.quantity !== "");
        
        if (hasData) card.classList.add("selected");
        card.innerHTML = `<b>–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ ${fridge.fridgeNumber}</b> <br> ${hasData ? '‚úÖ –ó–∞–ø–æ–≤–Ω–µ–Ω–æ' : '‚≠ïÔ∏è –ü—É—Å—Ç–æ'}`;
        card.onclick = () => showProducts(fridge);
        selector.appendChild(card);
      });

      // –ö–Ω–æ–ø–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—Å—å–æ–≥–æ
      const sendBtn = document.createElement("button");
      sendBtn.innerText = "üì§ –í–Ü–î–ü–†–ê–í–ò–¢–ò –í–°–ï –í –¢–ê–ë–õ–ò–¶–Æ";
      sendBtn.style = "width:100%; padding:15px; background:#3182ce; color:white; border:none; margin-top:20px;";
      sendBtn.onclick = syncToGoogleSheets;
      selector.appendChild(sendBtn);
    }

    function showProducts(fridge) {
      currentFridge = fridge;
      document.getElementById("fridge-selector").classList.remove("active");
      document.getElementById("product-list").classList.add("active");
      document.getElementById("current-fridge-title").innerText = `–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ ${fridge.fridgeNumber}`;
      
      const container = document.getElementById("products-container");
      container.innerHTML = "";
      
      // –ë–µ—Ä–µ–º–æ –∞–∫—Ç—É–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –∑ –ø–∞–º'—è—Ç—ñ
      const currentData = inventoryData[fridge.fridgeNumber] || [];

      fridge.products.forEach(product => {
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ, —â–æ –º–∏ —Ç–∞–º –Ω–∞–≤–≤–æ–¥–∏–ª–∏
        const savedItem = currentData.find(p => p.name === product.name);
        let val = savedItem ? savedItem.quantity : "";
        
        // –Ø–∫—â–æ val —Ü–µ 0, –∞–ª–µ –≤ —Å—Ç—Ä–æ–∫–æ–≤–æ–º—É –≤–∏–≥–ª—è–¥—ñ, –∑–∞–ª–∏—à–∞—î–º–æ "0". 
        // –Ø–∫—â–æ —Ü–µ –ø—É—Å—Ç–∞ —Å—Ç—Ä–æ–∫–∞ - —Ç–æ –ø—É—Å—Ç–∞.
        // –ì–æ–ª–æ–≤–Ω–µ: null –∞–±–æ undefined —Å—Ç–∞—é—Ç—å ""
        if (val === null || val === undefined) val = "";

        const div = document.createElement("div");
        div.className = "product-item";
        div.innerHTML = `
          <div>
            <b>${product.name}</b><br>
            <small>${product.category}</small>
          </div>
          <div class="quantity-input">
            <input type="text" 
                   placeholder="" 
                   value="${val}" 
                   data-name="${product.name}"
                   class="${val !== "" ? 'filled' : ''}"
                   oninput="this.className = this.value ? 'filled' : ''"
                   inputmode="decimal"> 
            <span>${product.unit}</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function saveCurrentFridge() {
      const inputs = document.querySelectorAll("#products-container input");
      const products = [];
      inputs.forEach(inp => {
        products.push({
          name: inp.getAttribute("data-name"),
          quantity: inp.value // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —è–∫ —î (–ø—É—Å—Ç–µ —Ç–∞–∫ –ø—É—Å—Ç–µ)
        });
      });
      
      inventoryData[currentFridge.fridgeNumber] = products;
      showFridgeSelector();
    }

    async function syncToGoogleSheets() {
      if (!confirm("–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –¥–∞–Ω—ñ –≤ Google –¢–∞–±–ª–∏—Ü—é?")) return;
      
      const dataToSend = Object.keys(inventoryData).map(fNum => ({
        fridgeNumber: fNum,
        products: inventoryData[fNum].filter(p => p.quantity !== "") // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç–µ, —â–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ? –ù—ñ, –∫—Ä–∞—â–µ –≤—Å–µ, —â–æ–± –∑–∞—Ç–µ—Ä—Ç–∏ —Å—Ç–∞—Ä–µ —è–∫—â–æ —Ç—Ä–µ–±–∞. –ê–ª–µ –¥–ª—è –µ–∫–æ–Ω–æ–º—ñ—ó –º–æ–∂–Ω–∞ —Ç—ñ–ª—å–∫–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ.
        // –í —Ç–≤–æ—î–º—É –≤–∏–ø–∞–¥–∫—É –∫—Ä–∞—â–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –≤—Å–µ, —â–æ –Ω–µ null
      }));

      try {
        const res = await fetch(`${API_URL}/api/inventory/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            inventoryDate: inventoryDate,
            inventoryData: dataToSend
          })
        });
        const ans = await res.json();
        if (ans.success) alert("‚úÖ –£—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
        else alert("–ü–æ–º–∏–ª–∫–∞: " + ans.error);
      } catch (e) {
        alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ");
      }
    }
  </script>
</body>
</html>
