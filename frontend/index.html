<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 2em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    
    .modal-content h2 {
      margin-bottom: 20px;
      color: #333;
    }
    
    .modal-content input {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      border: 2px solid #ddd;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .modal-content input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .modal-content button {
      background: #667eea;
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .modal-content button:hover {
      background: #5568d3;
    }
    
    /* –ï–∫—Ä–∞–Ω –≤–∏–±–æ—Ä—É —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ */
    #fridge-selector {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .fridge-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .fridge-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    .fridge-card.selected {
      background: #667eea;
      color: white;
    }
    
    .fridge-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }
    
    .fridge-number {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .fridge-count {
      font-size: 0.9em;
      opacity: 0.7;
    }
    
    /* –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ */
    #product-list {
      display: none;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    #product-list.active {
      display: block;
    }
    
    .top-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .back-btn, .save-now-btn {
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s;
      font-weight: 500;
    }
    
    .back-btn {
      background: #667eea;
      flex: 1;
    }
    
    .back-btn:hover {
      background: #5568d3;
    }
    
    .save-now-btn {
      background: #f59e0b;
      flex: 2;
    }
    
    .save-now-btn:hover {
      background: #d97706;
    }
    
    /* –ü–æ—à—É–∫ */
    .search-box {
      margin: 20px 0;
      position: sticky;
      top: 0;
      background: white;
      padding: 10px 0;
      z-index: 100;
    }
    
    .search-input {
      width: 100%;
      padding: 15px 20px;
      font-size: 1.1em;
      border: 2px solid #ddd;
      border-radius: 10px;
      transition: border-color 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .search-stats {
      margin-top: 10px;
      color: #666;
      font-size: 0.9em;
      display: flex;
      justify-content: space-between;
    }
    
    .autosave-indicator {
      color: #10b981;
      font-size: 0.85em;
    }
    
    .product-item {
      border-bottom: 1px solid #eee;
      padding: 20px 0;
      display: grid;
      grid-template-columns: 1fr auto 150px;
      gap: 20px;
      align-items: center;
      transition: background 0.3s;
    }
    
    .product-item.hidden {
      display: none;
    }
    
    .product-item.highlight {
      background: #fffbeb;
      padding: 20px 10px;
      border-radius: 8px;
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-info h3 {
      font-size: 1.1em;
      margin-bottom: 5px;
      color: #333;
    }
    
    .product-info .category {
      font-size: 0.9em;
      color: #666;
      background: #f0f0f0;
      display: inline-block;
      padding: 3px 10px;
      border-radius: 5px;
      margin-right: 10px;
    }
    
    .product-info .type {
      font-size: 0.9em;
      color: #667eea;
      font-weight: 500;
    }
    
    .current-quantity {
      text-align: right;
      font-size: 0.9em;
      color: #666;
    }
    
    .quantity-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .quantity-input input {
      width: 100px;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      text-align: center;
      transition: border-color 0.3s;
    }
    
    .quantity-input input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .quantity-input input.filled {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .quantity-input input.error {
      border-color: #ef4444;
      background: #fef2f2;
    }
    
    .quantity-input span {
      color: #666;
      font-size: 0.9em;
    }
    
    .save-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      margin-top: 30px;
      width: 100%;
      transition: background 0.3s;
    }
    
    .save-btn:hover {
      background: #059669;
    }
    
    .save-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó */
    .sync-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 18px 30px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 25px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .sync-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .sync-button:disabled {
      cursor: not-allowed;
    }
    
    .sync-icon {
      font-size: 1.3em;
    }
    
    .sync-text {
      flex: 1;
    }
    
    .sync-status {
      font-size: 0.9em;
      font-weight: normal;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* –ü—Ä–æ–≥—Ä–µ—Å */
    .progress-bar {
      background: #f0f0f0;
      height: 8px;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #667eea, #764ba2);
      height: 100%;
      transition: width 0.3s;
    }
    
    .message {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
      font-weight: 500;
    }
    
    .message.success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .message.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .message.warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .message.info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 1.2em;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –Ω–µ–∑–∞–ø–æ–≤–Ω–µ–Ω–∏—Ö –ø–æ–∑–∏—Ü—ñ–π */
    .unfilled-modal {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .unfilled-list {
      text-align: left;
      margin: 20px 0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .unfilled-item {
      padding: 10px;
      background: #fef3c7;
      margin: 5px 0;
      border-radius: 5px;
      border-left: 4px solid #f59e0b;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .modal-buttons button {
      flex: 1;
    }
    
    .btn-secondary {
      background: #6b7280 !important;
    }
    
    .btn-secondary:hover {
      background: #4b5563 !important;
    }
    
    .error-text {
      color: #ef4444;
      font-size: 0.9em;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ùÑÔ∏èüì¶ –Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫—ñ–≤ —Ç–∞ —Å—Ç–µ–ª–∞–∂—ñ–≤</h1>
    
    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è -->
    <div id="auth-modal" class="modal active">
      <div class="modal-content">
        <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>
        <p style="color: #666; margin-bottom: 20px;">–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –¥–æ—Å—Ç—É–ø—É —Ç–∞ –≤–∞—à–µ —ñ–º'—è</p>
        <input type="password" id="auth-code" placeholder="–ö–æ–¥ –¥–æ—Å—Ç—É–ø—É" />
        <input type="text" id="user-name" placeholder="–í–∞—à–µ —ñ–º'—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –Ü–≤–∞–Ω)" style="margin-top: 15px;" />
        <p id="auth-error" class="error-text" style="display: none;">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è</p>
        <button onclick="checkAuth()">–£–≤—ñ–π—Ç–∏</button>
      </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –¥–∞—Ç–∏ -->
    <div id="date-modal" class="modal">
      <div class="modal-content">
        <h2>üìÖ –î–∞—Ç–∞ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó</h2>
        <p style="color: #666; margin-bottom: 20px;">–í–≤–µ–¥—ñ—Ç—å –¥–∞—Ç—É –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó</p>
        <input type="date" id="inventory-date" />
        <button onclick="showSyncModal()">–î–∞–ª—ñ</button>
      </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó -->
    <div id="sync-modal" class="modal">
      <div class="modal-content">
        <h2>üîÑ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Poster</h2>
        <p style="color: #666; margin-bottom: 30px; font-size: 1.1em;">
          –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ –∑ Poster –ø–µ—Ä–µ–¥ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—î—é?
        </p>
        <div style="display: flex; gap: 15px; justify-content: center;">
          <button 
            onclick="startWithSync()" 
            style="background: #10b981; flex: 1;">
            –¢–∞–∫
          </button>
          <button 
            onclick="startWithoutSync()" 
            style="background: #6b7280; flex: 1;">
            –ù—ñ
          </button>
        </div>
        <div id="sync-status" style="margin-top: 20px; font-size: 0.9em; color: #666;"></div>
      </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –Ω–µ–∑–∞–ø–æ–≤–Ω–µ–Ω–∏—Ö –ø–æ–∑–∏—Ü—ñ–π -->
    <div id="unfilled-modal" class="modal">
      <div class="modal-content unfilled-modal">
        <h2>‚ö†Ô∏è –ù–µ–∑–∞–ø–æ–≤–Ω–µ–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó</h2>
        <p style="color: #666; margin-bottom: 20px;">
          –í–∏ –Ω–µ –∑–∞–ø–æ–≤–Ω–∏–ª–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è?
        </p>
        <div id="unfilled-list" class="unfilled-list"></div>
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="closeUnfilledModal()">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å</button>
          <button onclick="confirmSave()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –±—É–¥—å-—è–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É</button>
        </div>
      </div>
    </div>
    
    <div id="loading" class="loading">
      –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...
    </div>
    
    <!-- –ï–∫—Ä–∞–Ω –≤–∏–±–æ—Ä—É —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ -->
    <div id="fridge-selector" style="display: none;"></div>
    
    <!-- –ï–∫—Ä–∞–Ω —Å–ø–∏—Å–∫—É –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ -->
    <div id="product-list">
      <div class="top-buttons">
        <button class="back-btn" onclick="showFridgeSelector()">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
      <h2 id="current-fridge-title"></h2>
      
      <!-- –ü–æ—à—É–∫ -->
      <div class="search-box">
        <input 
          type="text" 
          class="search-input" 
          id="search-input" 
          placeholder="üîç –ü–æ—à—É–∫ –ø—Ä–æ–¥—É–∫—Ç—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –∫–æ–∫–∞, –ø–∏–≤–æ, —Å–∞–ª–∞—Ç...)"
          oninput="filterProducts()"
        />
        <div class="search-stats">
          <span id="search-stats-text"></span>
          <span class="autosave-indicator" id="autosave-indicator"></span>
        </div>
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <div id="message"></div>
      <div id="products-container"></div>
      <button class="save-btn" onclick="saveCurrentFridge()">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ª–∏—à–∫–∏ —Ü—å–æ–≥–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞</button>
    </div>
  </div>

  <script>
    const API_URL = "https://inventory-duab.onrender.com";
    const AUTH_CODE = "1234"; // –ó–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à –∫–æ–¥
    
    let allFridges = [];
    let currentFridge = null;
    let inventoryData = {};
    let inventoryDate = null;
    let currentProducts = [];
    let hasUnsavedChanges = false;
    let autosaveInterval = null;
    let isExistingInventory = false;
    let currentUserName = ""; // –Ü–º'—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    
    // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏–ø—É —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞/—Å—Ç–µ–ª–∞–∂–∞
    const SHELVES = ['3', '4', '8', '16']; // –ù–æ–º–µ—Ä–∏ —Å—Ç–µ–ª–∞–∂—ñ–≤
    
    function getFridgeType(number) {
      if (number === 'ALL') return '–£—Å—ñ –ø—Ä–æ–¥—É–∫—Ç–∏';
      return SHELVES.includes(String(number)) ? '–°—Ç–µ–ª–∞–∂' : '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫';
    }
    
    function getFridgeIcon(number) {
      if (number === 'ALL') return 'üìã';
      return SHELVES.includes(String(number)) ? 'üì¶' : '‚ùÑÔ∏è';
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    function checkAuth() {
      const code = document.getElementById("auth-code").value;
      const userName = document.getElementById("user-name").value.trim();
      
      if (!userName) {
        document.getElementById("auth-error").textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è";
        document.getElementById("auth-error").style.display = "block";
        return;
      }
      
      if (code === AUTH_CODE) {
        currentUserName = userName;
        localStorage.setItem("userName", userName); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–º'—è
        
        document.getElementById("auth-modal").classList.remove("active");
        document.getElementById("date-modal").classList.add("active");
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—é –¥–∞—Ç—É
        document.getElementById("inventory-date").valueAsDate = new Date();
      } else {
        document.getElementById("auth-error").textContent = "–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥";
        document.getElementById("auth-error").style.display = "block";
      }
    }
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–µ —ñ–º'—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    window.addEventListener("DOMContentLoaded", () => {
      const savedName = localStorage.getItem("userName");
      if (savedName) {
        document.getElementById("user-name").value = savedName;
      }
    });

    // Enter –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    document.getElementById("auth-code")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") checkAuth();
    });

    // –ü–æ—á–∞—Ç–æ–∫ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó
    // === –§–£–ù–ö–¶–Ü–á –ë–õ–û–ö–£–í–ê–ù–ù–Ø ===
    
    let pendingFridgeToUnlock = null; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –¥–ª—è —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è
    
    // –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
    function showLockModal(fridge, lock) {
      pendingFridgeToUnlock = fridge;
      
      const lockedInfo = document.getElementById("locked-info");
      lockedInfo.innerHTML = `
        <strong>${lock.userName}</strong> –∑–∞—Ä–∞–∑ –ø—Ä–∞—Ü—é—î –∑ <strong>${getFridgeType(fridge.fridgeNumber)} ${fridge.fridgeNumber}</strong><br>
        <span style="color: #999; font-size: 0.9em;">–ü–æ—á–∞–≤ –æ ${lock.time}</span>
      `;
      
      document.getElementById("locked-modal").classList.add("active");
    }
    
    // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    function closeLockModal() {
      document.getElementById("locked-modal").classList.remove("active");
      pendingFridgeToUnlock = null;
    }
    
    // –ü—Ä–∏–º—É—Å–æ–≤–æ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ —ñ –≤—ñ–¥–∫—Ä–∏—Ç–∏
    async function forceUnlockAndOpen() {
      if (!pendingFridgeToUnlock) return;
      
      console.log(`üîì –ü—Ä–∏–º—É—Å–æ–≤–µ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è: ${pendingFridgeToUnlock.fridgeNumber}`);
      
      // –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏
      await unlockLocation(pendingFridgeToUnlock.fridgeNumber);
      
      // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
      closeLockModal();
      
      // –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫
      await showProducts(pendingFridgeToUnlock);
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫/—Å—Ç–µ–ª–∞–∂
    async function checkLocationLock(locationNumber) {
      try {
        const response = await fetch(`${API_URL}/api/locks/check/${locationNumber}`);
        const result = await response.json();
        return result.locked ? result : null;
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è:", error);
        return null;
      }
    }
    
    // –ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫/—Å—Ç–µ–ª–∞–∂
    async function lockLocation(locationNumber) {
      try {
        const response = await fetch(`${API_URL}/api/locks/lock`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            locationNumber: String(locationNumber),
            userName: currentUserName
          })
        });
        return await response.json();
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è:", error);
        return { success: false, error: error.message };
      }
    }
    
    // –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫/—Å—Ç–µ–ª–∞–∂
    async function unlockLocation(locationNumber) {
      try {
        const response = await fetch(`${API_URL}/api/locks/unlock/${locationNumber}`, {
          method: "DELETE"
        });
        return await response.json();
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è:", error);
        return { success: false };
      }
    }
    
    // –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
    async function getAllLocationLocks() {
      try {
        const response = await fetch(`${API_URL}/api/locks/all`);
        const result = await response.json();
        return result.success ? result.locks : {};
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –±–ª–æ–∫—É–≤–∞–Ω—å:", error);
        return {};
      }
    }
    
    // === –ü–û–ö–ê–ó–ê–¢–ò –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–á ===
    
    function showSyncModal() {
      const dateInput = document.getElementById("inventory-date").value;
      if (!dateInput) {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥–∞—Ç—É —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó");
        return;
      }
      
      inventoryDate = dateInput;
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –¥–∞—Ç–æ–π –∏ —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é
      document.getElementById("date-modal").classList.remove("active");
      startInventory();
    }
    
    // === –ü–û–ß–ê–¢–ò –ó –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–Ñ–Æ ===
    
    async function startWithSync() {
      const syncStatus = document.getElementById("sync-status");
      const buttons = document.querySelectorAll("#sync-modal button");
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
      buttons.forEach(btn => btn.disabled = true);
      
      syncStatus.textContent = "‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Poster...";
      syncStatus.style.color = "#666";
      
      try {
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Å–µ ID
        const response = await fetch(`${API_URL}/api/sync-all-ids`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || "–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó");
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const added = result.added || 0;
        const updated = result.updated || 0;
        const deleted = result.deleted || 0;
        
        let message = "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!";
        if (added > 0) message += ` üÜï –î–æ–¥–∞–Ω–æ: ${added}`;
        if (updated > 0) message += ` üîÑ –û–Ω–æ–≤–ª–µ–Ω–æ: ${updated}`;
        if (deleted > 0) message += ` ‚ùå –í–∏–¥–∞–ª–µ–Ω–æ: ${deleted}`;
        
        syncStatus.textContent = message;
        syncStatus.style.color = "#10b981";
        
        // –ñ–¥–µ–º 1.5 —Å–µ–∫—É–Ω–¥—ã —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é
        document.getElementById("sync-modal").classList.remove("active");
        await startInventory();
        
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó:", error);
        syncStatus.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        syncStatus.style.color = "#ef4444";
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        buttons.forEach(btn => btn.disabled = false);
      }
    }
    
    // === –ü–û–ß–ê–¢–ò –ë–ï–ó –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–á ===
    
    async function startWithoutSync() {
      document.getElementById("sync-modal").classList.remove("active");
      await startInventory();
    }
    
    // === –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–Ø –ó POSTER (–∫–Ω–æ–ø–∫–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ) ===
    
    async function syncWithPoster() {
      const button = document.querySelector(".sync-button");
      const statusEl = document.getElementById("inline-sync-status");
      const syncIcon = button.querySelector(".sync-icon");
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      button.disabled = true;
      button.style.opacity = "0.6";
      syncIcon.style.animation = "spin 1s linear infinite";
      
      statusEl.textContent = "–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...";
      statusEl.style.color = "#666";
      
      try {
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Å–µ ID
        const response = await fetch(`${API_URL}/api/sync-all-ids`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || "–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó");
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const total = result.total || 0;
        statusEl.textContent = `‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ ${total} –ø–æ–∑–∏—Ü—ñ–π`;
        statusEl.style.color = "#10b981";
        
        // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
        setTimeout(() => {
          statusEl.textContent = "";
          button.disabled = false;
          button.style.opacity = "1";
          syncIcon.style.animation = "";
        }, 3000);
        
      } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó:", error);
        statusEl.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
        statusEl.style.color = "#ef4444";
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          statusEl.textContent = "";
          button.disabled = false;
          button.style.opacity = "1";
          syncIcon.style.animation = "";
        }, 3000);
      }
    }
    
    // === –û–°–ù–û–í–ù–ê –õ–û–ì–Ü–ö–ê ===

    async function startInventory() {
      // inventoryDate —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ showSyncModal()
      
      // ‚úÖ –°–¢–í–û–†–Æ–Ñ–ú–û –ê–†–ö–£–® –û–î–†–ê–ó–£ –ü–†–ò –í–ò–ë–û–†–Ü –î–ê–¢–ò
      try {
        const response = await fetch(`${API_URL}/api/inventory/init-sheet`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ inventoryDate })
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (result.existed) {
            console.log(`üìã –ü—Ä–æ–¥–æ–≤–∂—É—é —ñ—Å–Ω—É—é—á—É —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—é: ${result.sheetName}`);
          } else {
            console.log(`‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π –∞—Ä–∫—É—à: ${result.sheetName}`);
          }
        }
      } catch (error) {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞—Ä–∫—É—à–∞:", error);
      }
      
      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —á–µ—Ä–Ω–µ—Ç–∫—É –∑ localStorage
      loadDraft();
      
      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
      await loadData();
      
      // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      startAutosave();
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
    async function loadData() {
      try {
        const response = await fetch(`${API_URL}/api/inventory/products?date=${inventoryDate}`);
        const result = await response.json();
        
        allFridges = result.data || result;
        isExistingInventory = result.existingInventory || false;
        
        if (isExistingInventory) {
          // –Ø–∫—â–æ —ñ—Å–Ω—É—î —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è –∑–∞ —Ü—é –¥–∞—Ç—É, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–∞–Ω—ñ
          allFridges.forEach(fridge => {
            inventoryData[fridge.fridgeNumber] = fridge.products.map(p => ({
              name: p.name,
              quantity: p.savedQuantity || ""
            }));
          });
          
          showMessage(`üìã –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —ñ—Å–Ω—É—é—á—É —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—é –∑–∞ ${inventoryDate}`, "info");
        }
        
        document.getElementById("loading").style.display = "none";
        showFridgeSelector();
      } catch (error) {
        document.getElementById("loading").innerHTML = 
          `<div class="message error">‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}</div>`;
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    function showMessage(text, type = "success") {
      const messageDiv = document.getElementById("message");
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      setTimeout(() => {
        messageDiv.textContent = "";
        messageDiv.className = "message";
      }, 5000);
    }

    // –ü–æ–∫–∞–∑–∞—Ç–∏ –µ–∫—Ä–∞–Ω –≤–∏–±–æ—Ä—É —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫—ñ–≤
    async function showFridgeSelector() {
      // –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ —è–∫—â–æ –±—É–≤ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π
      if (currentFridge) {
        await unlockLocation(currentFridge.fridgeNumber);
      }
      
      document.getElementById("fridge-selector").style.display = "grid";
      document.getElementById("product-list").classList.remove("active");
      
      const selector = document.getElementById("fridge-selector");
      selector.innerHTML = "";
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      const syncButton = document.createElement("button");
      syncButton.className = "sync-button";
      syncButton.innerHTML = `
        <span class="sync-icon">üîÑ</span>
        <span class="sync-text">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑ Poster</span>
        <span class="sync-status" id="inline-sync-status"></span>
      `;
      syncButton.style.gridColumn = "1 / -1";
      syncButton.onclick = syncWithPoster;
      selector.appendChild(syncButton);
      
      // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
      const locks = await getAllLocationLocks();
      
      allFridges.forEach(fridge => {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ –∏ "–ë–µ–∑ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞"
        if (!fridge.fridgeNumber || 
            fridge.fridgeNumber === '' || 
            fridge.fridgeNumber === '–ë–µ–∑ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞' ||
            fridge.fridgeNumber === '#N/A' ||
            fridge.fridgeNumber === 'undefined') {
          return;
        }
        
        const card = document.createElement("div");
        card.className = "fridge-card";
        
        const hasData = inventoryData[fridge.fridgeNumber] && 
                        inventoryData[fridge.fridgeNumber].some(p => p.quantity !== "");
        
        if (hasData) {
          card.classList.add("selected");
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π
        const lock = locks[fridge.fridgeNumber];
        const isLockedByOther = lock && lock.userName !== currentUserName;
        
        card.innerHTML = `
          <div class="fridge-icon">${getFridgeIcon(fridge.fridgeNumber)}</div>
          <div class="fridge-number">${getFridgeType(fridge.fridgeNumber)} ${fridge.fridgeNumber === 'ALL' ? '' : fridge.fridgeNumber}</div>
          <div class="fridge-count">${fridge.products.length} –ø–æ–∑–∏—Ü—ñ–π</div>
          ${hasData ? '<div style="margin-top: 10px;">‚úÖ –ó–∞–ø–æ–≤–Ω–µ–Ω–æ</div>' : ''}
          ${isLockedByOther ? `<div style="margin-top: 10px; color: #ef4444;">üîí –†–∞—Ö—É—î: ${lock.userName}</div>` : ''}
        `;
        
        card.onclick = () => showProducts(fridge);
        selector.appendChild(card);
      });
      
      if (Object.keys(inventoryData).length > 0) {
        const saveAllBtn = document.createElement("button");
        saveAllBtn.className = "save-btn";
        saveAllBtn.textContent = "‚úÖ –ü—Ä–æ–≤–µ—Å—Ç–∏ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—é";
        saveAllBtn.style.gridColumn = "1 / -1";
        saveAllBtn.onclick = checkAndSaveAll;
        selector.appendChild(saveAllBtn);
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞
    async function showProducts(fridge) {
      console.log("üìÇ –í—ñ–¥–∫—Ä–∏–≤–∞—é —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫:", fridge.fridgeNumber);
      
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
      const lock = await checkLocationLock(fridge.fridgeNumber);
      
      if (lock && lock.userName !== currentUserName) {
        // –ü–æ–∫–∞–∑—É—î–º–æ –≥–∞—Ä–Ω–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        showLockModal(fridge, lock);
        return;
      }
      
      // –ë–ª–æ–∫—É—î–º–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫
      const lockResult = await lockLocation(fridge.fridgeNumber);
      if (!lockResult.success && lockResult.error) {
        alert(`‚ùå –ü–æ–º–∏–ª–∫–∞ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è: ${lockResult.error}\n\n–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–∞—á–µ–∫–∞–π—Ç–µ —Ö–≤–∏–ª–∏–Ω—É.`);
        return;
      }
      
      // üîÑ –ó–ê–í–ê–ù–¢–ê–ñ–£–Ñ–ú–û –°–í–Ü–ñ–Ü –î–ê–ù–Ü –ó –°–ï–†–í–ï–†–ê
      console.log("üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é —Å–≤—ñ–∂—ñ –¥–∞–Ω—ñ –¥–ª—è –¥–∞—Ç–∏:", inventoryDate);
      
      try {
        const response = await fetch(`${API_URL}/api/inventory/products?date=${inventoryDate}`);
        const result = await response.json();
        
        console.log("üì¶ –û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:", result);
        
        if (result.data) {
          // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ü–µ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –≤ —Å–≤—ñ–∂–∏—Ö –¥–∞–Ω–∏—Ö
          const freshFridgeData = result.data.find(f => f.fridgeNumber === fridge.fridgeNumber);
          
          console.log("üéØ –°–≤—ñ–∂—ñ –¥–∞–Ω—ñ –¥–ª—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞", fridge.fridgeNumber, ":", freshFridgeData);
          
          if (freshFridgeData && freshFridgeData.products) {
            // –û–Ω–æ–≤–ª—é—î–º–æ fridge –æ–±'—î–∫—Ç —Å–≤—ñ–∂–∏–º–∏ –¥–∞–Ω–∏–º–∏
            fridge.products = freshFridgeData.products;
            
            // –¢–∞–∫–æ–∂ –æ–Ω–æ–≤–ª—é—î–º–æ –≤ allFridges
            const index = allFridges.findIndex(f => f.fridgeNumber === fridge.fridgeNumber);
            if (index >= 0) {
              allFridges[index].products = freshFridgeData.products;
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ inventoryData –∑ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏
            const productsWithData = freshFridgeData.products.filter(p => p.savedQuantity && p.savedQuantity !== "");
            
            console.log("üíæ –ü—Ä–æ–¥—É–∫—Ç–∏ –∑—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏:", productsWithData);
            
            if (productsWithData.length > 0) {
              if (!inventoryData[fridge.fridgeNumber]) {
                inventoryData[fridge.fridgeNumber] = [];
              }
              
              productsWithData.forEach(serverProduct => {
                const existingIndex = inventoryData[fridge.fridgeNumber].findIndex(p => p.name === serverProduct.name);
                
                if (existingIndex >= 0) {
                  // –Ø–∫—â–æ –≤–∂–µ —î - –æ–Ω–æ–≤–ª—é—î–º–æ
                  inventoryData[fridge.fridgeNumber][existingIndex].quantity = serverProduct.savedQuantity;
                  console.log("‚ôªÔ∏è –û–Ω–æ–≤–ª–µ–Ω–æ:", serverProduct.name, "=", serverProduct.savedQuantity);
                } else {
                  // –î–æ–¥–∞—î–º–æ –Ω–æ–≤–∏–π
                  inventoryData[fridge.fridgeNumber].push({
                    name: serverProduct.name,
                    quantity: serverProduct.savedQuantity
                  });
                  console.log("‚ûï –î–æ–¥–∞–Ω–æ:", serverProduct.name, "=", serverProduct.savedQuantity);
                }
              });
            }
          }
          
          console.log("‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ –¥–∞–Ω—ñ –¥–ª—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞", fridge.fridgeNumber);
        }
      } catch (error) {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–≤—ñ–∂–∏—Ö –¥–∞–Ω–∏—Ö:", error);
        // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ —Ä–æ–±–æ—Ç—É –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏
      }
      
      currentFridge = fridge;
      currentProducts = fridge.products;
      document.getElementById("fridge-selector").style.display = "none";
      document.getElementById("product-list").classList.add("active");
      document.getElementById("current-fridge-title").textContent = 
        `${getFridgeType(fridge.fridgeNumber)} ${fridge.fridgeNumber}`;
      
      document.getElementById("search-input").value = "";
      
      const container = document.getElementById("products-container");
      container.innerHTML = "";
      
      const savedData = inventoryData[fridge.fridgeNumber] || [];
      
      console.log("üìã –í—ñ–¥–æ–±—Ä–∞–∂–∞—é –ø—Ä–æ–¥—É–∫—Ç–∏ –∑ –¥–∞–Ω–∏–º–∏:", savedData);
      
      fridge.products.forEach((product) => {
        const savedProduct = savedData.find(p => p.name === product.name);
        const quantity = savedProduct ? savedProduct.quantity : (product.savedQuantity || "");
        
        const item = document.createElement("div");
        item.className = "product-item";
        item.setAttribute("data-name", product.name.toLowerCase());
        item.setAttribute("data-category", product.category.toLowerCase());
        
        item.innerHTML = `
          <div class="product-info">
            <h3>${product.name}</h3>
            <span class="category">${product.category}</span>
            <span class="type">${product.type}</span>
          </div>
          <div class="current-quantity">
            ${product.currentQuantity && product.currentQuantity !== "0" ? `–ü–æ—Ç–æ—á–Ω–∏–π: ${product.currentQuantity}` : ''}
          </div>
          <div class="quantity-input">
            <input 
              type="text" 
              placeholder="0 –∞–±–æ 1+2"
              value="${quantity}"
              data-product-name="${product.name}"
              data-unit="${product.unit || '–∫–≥'}"
              class="${quantity !== '' ? 'filled' : ''}"
              oninput="handleInput(this)"
              onblur="calculateExpression(this)"
            />
            <span>${product.unit || '–∫–≥'}</span>
          </div>
        `;
        container.appendChild(item);
      });
      
      updateProgress();
      updateSearchStats();
    }

    // –û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è
    function handleInput(input) {
      hasUnsavedChanges = true;
      
      // –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è: –∑–∞–º—ñ–Ω–∞ –∫–æ–º–∏ –Ω–∞ –∫—Ä–∞–ø–∫—É
      let value = input.value.replace(/,/g, '.');
      
      // –í–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ–±—ñ–ª—ñ–≤ —Ç–∞ —Ç–µ–∫—Å—Ç—É (–∫–≥, –≥, —Ç.–¥.)
      value = value.replace(/[^\d+\-*/().]/g, '');
      
      input.value = value;
      
      // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–ª–∞—Å—É –ø–æ–º–∏–ª–∫–∏
      input.classList.remove("error");
      
      updateProgress();
      markAsFilled(input);
    }

    // –û–±—á–∏—Å–ª–µ–Ω–Ω—è –≤–∏—Ä–∞–∑—ñ–≤ (1+2, 5+3.5)
    function calculateExpression(input) {
      const value = input.value.trim();
      
      if (value === "") {
        input.classList.remove("filled");
        return;
      }
      
      // –Ø–∫—â–æ —î –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω—ñ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∏, –æ–±—á–∏—Å–ª—é—î–º–æ
      if (/[+\-*/]/.test(value)) {
        try {
          const result = eval(value);
          if (!isNaN(result) && isFinite(result)) {
            input.value = result.toFixed(2).replace(/\.?0+$/, '');
            input.classList.add("filled");
          } else {
            input.classList.add("error");
          }
        } catch (e) {
          input.classList.add("error");
        }
      } else {
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —Ü–µ —á–∏—Å–ª–æ
        const num = parseFloat(value);
        if (isNaN(num)) {
          input.classList.add("error");
        } else {
          input.value = num.toString();
          input.classList.add("filled");
        }
      }
      
      updateProgress();
    }

    // –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –ø–æ–ª–µ —è–∫ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ
    function markAsFilled(input) {
      if (input.value !== "") {
        input.classList.add("filled");
      } else {
        input.classList.remove("filled");
      }
    }

    // –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø—Ä–æ–¥—É–∫—Ç—ñ–≤
    function filterProducts() {
      const searchTerm = document.getElementById("search-input").value.toLowerCase();
      const items = document.querySelectorAll(".product-item");
      let visibleCount = 0;
      
      items.forEach(item => {
        const name = item.getAttribute("data-name");
        const category = item.getAttribute("data-category");
        
        if (name.includes(searchTerm) || category.includes(searchTerm)) {
          item.classList.remove("hidden");
          if (searchTerm !== "") {
            item.classList.add("highlight");
          } else {
            item.classList.remove("highlight");
          }
          visibleCount++;
        } else {
          item.classList.add("hidden");
          item.classList.remove("highlight");
        }
      });
      
      updateSearchStats(visibleCount, items.length);
    }

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—à—É–∫—É
    function updateSearchStats(visible, total) {
      const statsDiv = document.getElementById("search-stats-text");
      const searchTerm = document.getElementById("search-input").value;
      
      if (!total) {
        total = document.querySelectorAll(".product-item").length;
        visible = total;
      }
      
      if (searchTerm) {
        statsDiv.textContent = `–ó–Ω–∞–π–¥–µ–Ω–æ: ${visible} –∑ ${total} –ø–æ–∑–∏—Ü—ñ–π`;
      } else {
        statsDiv.textContent = `–í—Å—å–æ–≥–æ –ø–æ–∑–∏—Ü—ñ–π: ${total}`;
      }
    }

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É
    function updateProgress() {
      const inputs = document.querySelectorAll("#products-container input");
      const filled = Array.from(inputs).filter(input => input.value !== "").length;
      const total = inputs.length;
      const percent = (filled / total) * 100;
      
      document.getElementById("progress-fill").style.width = percent + "%";
    }

    // –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞
    async function saveCurrentFridge() {
      const inputs = document.querySelectorAll("#products-container input");
      const products = [];
      
      inputs.forEach(input => {
        const productName = input.getAttribute("data-product-name");
        const quantity = input.value;
        
        products.push({
          name: productName,
          quantity: quantity
        });
      });
      
      inventoryData[currentFridge.fridgeNumber] = products;
      hasUnsavedChanges = false;
      saveDraft();
      
      // ‚úÖ –ó–ë–ï–†–Ü–ì–ê–Ñ–ú–û –í GOOGLE SHEETS (–ø–µ—Ä–µ–∑–∞–ø–∏—Å)
      await saveToGoogleSheetsSync();
      
      showMessage("‚úÖ –î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ! –ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞.", "success");
      
      setTimeout(() => {
        showFridgeSelector();
      }, 1500);
    }
    
    // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ –∑ Google Sheets
    async function saveToGoogleSheetsSync() {
      try {
        const fridgeArray = [{
          fridgeNumber: currentFridge.fridgeNumber,
          products: inventoryData[currentFridge.fridgeNumber]
            .filter(p => p.quantity !== "")
            .map(p => ({
              name: p.name,
              quantity: parseFloat(p.quantity.replace(/,/g, '.')) || 0
            }))
        }];
        
        if (fridgeArray[0].products.length === 0) {
          console.log("‚ÑπÔ∏è –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è");
          return;
        }
        
        console.log("üíæ –ó–±–µ—Ä—ñ–≥–∞—é –≤ Google Sheets:", fridgeArray);
        
        const response = await fetch(`${API_URL}/api/inventory/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            inventoryData: fridgeArray,
            inventoryDate: inventoryDate
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log("‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ Google Sheets");
        } else {
          console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:", result.error);
        }
      } catch (error) {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:", error);
      }
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Google Sheets (–±–µ–∑ –∑–∞–∫—Ä–∏—Ç—Ç—è —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó)
    async function syncToGoogleSheets() {
      // –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –ª–æ–∫–∞–ª—å–Ω–æ
      const inputs = document.querySelectorAll("#products-container input");
      const products = [];
      
      inputs.forEach(input => {
        const quantity = input.value;
        products.push({
          name: input.getAttribute("data-product-name"),
          quantity: quantity
        });
      });
      
      inventoryData[currentFridge.fridgeNumber] = products;
      saveDraft();
      
      // –ì–æ—Ç—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ - —Ç—ñ–ª—å–∫–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó
      const fridgeArray = Object.keys(inventoryData).map(fridgeNumber => ({
        fridgeNumber,
        products: inventoryData[fridgeNumber]
          .filter(p => p.quantity !== "") // –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ
          .map(p => ({
            name: p.name,
            quantity: parseFloat(p.quantity.replace(/,/g, '.')) || 0
          }))
      })).filter(f => f.products.length > 0); // –¢—ñ–ª—å–∫–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ –∑ –¥–∞–Ω–∏–º–∏
      
      try {
        showMessage("üîÑ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Google Sheets...", "info");
        
        const response = await fetch(`${API_URL}/api/inventory/save`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            inventoryData: fridgeArray,
            inventoryDate: inventoryDate
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage("‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –∑ Google Sheets!", "success");
          hasUnsavedChanges = false;
        } else {
          showMessage("‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó: " + result.error, "error");
        }
      } catch (error) {
        showMessage("‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó: " + error.message, "error");
      }
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–µ–∑–∞–ø–æ–≤–Ω–µ–Ω–∏—Ö –ø–æ–∑–∏—Ü—ñ–π
    function checkAndSaveAll() {
      const unfilled = [];
      
      Object.keys(inventoryData).forEach(fridgeNum => {
        inventoryData[fridgeNum].forEach(product => {
          if (product.quantity === "") {
            unfilled.push({
              fridge: fridgeNum,
              name: product.name
            });
          }
        });
      });
      
      if (unfilled.length > 0) {
        showUnfilledModal(unfilled);
      } else {
        saveAllInventory();
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–µ–∑–∞–ø–æ–≤–Ω–µ–Ω–∏—Ö
    function showUnfilledModal(unfilled) {
      const modal = document.getElementById("unfilled-modal");
      const list = document.getElementById("unfilled-list");
      
      list.innerHTML = "";
      
      unfilled.forEach(item => {
        const div = document.createElement("div");
        div.className = "unfilled-item";
        div.textContent = `${getFridgeType(item.fridge)} ${item.fridge}: ${item.name}`;
        list.appendChild(div);
      });
      
      modal.classList.add("active");
    }

    // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    function closeUnfilledModal() {
      document.getElementById("unfilled-modal").classList.remove("active");
    }

    // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
    function confirmSave() {
      closeUnfilledModal();
      saveAllInventory();
    }

    // –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—é —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—é
    async function saveAllInventory() {
      try {
        // –ì–æ—Ç—É—î–º–æ –¥–∞–Ω—ñ - —Ç—ñ–ª—å–∫–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó
        const fridgeArray = Object.keys(inventoryData).map(fridgeNumber => ({
          fridgeNumber,
          products: inventoryData[fridgeNumber]
            .filter(p => p.quantity !== "") // –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ
            .map(p => ({
              name: p.name,
              quantity: parseFloat(p.quantity.replace(/,/g, '.')) || 0
            }))
        })).filter(f => f.products.length > 0); // –¢—ñ–ª—å–∫–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ –∑ –¥–∞–Ω–∏–º–∏
        
        const response = await fetch(`${API_URL}/api/inventory/save`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            inventoryData: fridgeArray,
            inventoryDate: inventoryDate
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ –∫–Ω–æ–ø–∫–æ—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è PDF
          const modalHtml = `
            <div style="text-align: center;">
              <h2 style="color: #10b981; margin-bottom: 20px;">‚úÖ –Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—é —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!</h2>
              <p style="font-size: 1.1em; margin-bottom: 30px;">–ê—Ä–∫—É—à: <strong>${result.sheetName}</strong></p>
              <button 
                onclick="downloadInventoryPDF('${result.sheetName}')" 
                style="background: #3b82f6; color: white; border: none; padding: 15px 30px; 
                       border-radius: 10px; font-size: 1.1em; cursor: pointer; margin-bottom: 15px;
                       display: inline-flex; align-items: center; gap: 10px;"
                onmouseover="this.style.background='#2563eb'" 
                onmouseout="this.style.background='#3b82f6'">
                üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF
              </button>
              <br>
              <button 
                onclick="location.reload()" 
                style="background: #6b7280; color: white; border: none; padding: 12px 25px; 
                       border-radius: 10px; font-size: 1em; cursor: pointer;"
                onmouseover="this.style.background='#4b5563'" 
                onmouseout="this.style.background='#6b7280'">
                –ó–∞–∫—Ä–∏—Ç–∏
              </button>
            </div>
          `;
          
          // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
          const existingModal = document.getElementById("success-modal");
          if (existingModal) {
            existingModal.remove();
          }
          
          const modal = document.createElement("div");
          modal.id = "success-modal";
          modal.className = "modal active";
          modal.innerHTML = `<div class="modal-content">${modalHtml}</div>`;
          document.body.appendChild(modal);
          
          inventoryData = {};
          inventoryDate = null;
          hasUnsavedChanges = false;
          clearDraft();
          stopAutosave();
        } else {
          alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + result.error);
        }
      } catch (error) {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: " + error.message);
      }
    }
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó
    async function downloadInventoryPDF(sheetName) {
      try {
        const button = event.target;
        button.disabled = true;
        button.textContent = "‚è≥ –ì–µ–Ω–µ—Ä—É—é PDF...";
        
        const response = await fetch(`${API_URL}/api/inventory/export-pdf/${encodeURIComponent(sheetName)}`);
        const result = await response.json();
        
        if (result.success) {
          // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ PDF –≤ –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ
          window.open(result.downloadUrl, '_blank');
          button.textContent = "‚úÖ PDF –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!";
          
          setTimeout(() => {
            button.disabled = false;
            button.textContent = "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF";
          }, 2000);
        } else {
          alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É: " + result.error);
          button.disabled = false;
          button.textContent = "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF";
        }
      } catch (error) {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + error.message);
        event.target.disabled = false;
        event.target.textContent = "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF";
      }
    }

    // ============ –ê–í–¢–û–ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø ============
    
    function startAutosave() {
      autosaveInterval = setInterval(() => {
        saveDraft(); // ‚úÖ –¢—ñ–ª—å–∫–∏ localStorage
        // saveToGoogleSheets(); - –í–ò–ú–ö–ù–ï–ù–û! –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –∫–Ω–æ–ø–∫–∏
        showAutosaveIndicator();
      }, 10000); // –ö–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
    }

    function stopAutosave() {
      if (autosaveInterval) {
        clearInterval(autosaveInterval);
      }
    }

    function saveDraft() {
      const draft = {
        inventoryData,
        inventoryDate,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem("inventory_draft", JSON.stringify(draft));
    }
    
    // ‚úÖ –ê–í–¢–û–ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –í GOOGLE SHEETS
    async function saveToGoogleSheets() {
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –¥–∞–Ω—ñ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      if (!inventoryData || Object.keys(inventoryData).length === 0) {
        return;
      }
      
      try {
        // –ì–æ—Ç—É—î–º–æ –¥–∞–Ω—ñ - —Ç—ñ–ª—å–∫–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó
        const fridgeArray = Object.keys(inventoryData).map(fridgeNumber => ({
          fridgeNumber,
          products: inventoryData[fridgeNumber]
            .filter(p => p.quantity !== "") // –¢—ñ–ª—å–∫–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ
            .map(p => ({
              name: p.name,
              quantity: parseFloat(p.quantity.replace(/,/g, '.')) || 0
            }))
        })).filter(f => f.products.length > 0); // –¢—ñ–ª—å–∫–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ –∑ –¥–∞–Ω–∏–º–∏
        
        if (fridgeArray.length === 0) {
          return; // –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
        }
        
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch(`${API_URL}/api/inventory/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            inventoryData: fridgeArray,
            inventoryDate: inventoryDate
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log("üíæ –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Google Sheets —É—Å–ø—ñ—à–Ω–µ");
        }
      } catch (error) {
        console.error("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:", error);
        // –ù–µ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, —â–æ–± –Ω–µ –∑–∞–≤–∞–∂–∞—Ç–∏ —Ä–æ–±–æ—Ç—ñ
      }
    }

    function loadDraft() {
      const draft = localStorage.getItem("inventory_draft");
      if (draft) {
        const data = JSON.parse(draft);
        if (data.inventoryDate === inventoryDate) {
          inventoryData = data.inventoryData;
          console.log("üìã –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —á–µ—Ä–Ω–µ—Ç–∫—É –∑ localStorage");
        }
      }
    }

    function clearDraft() {
      localStorage.removeItem("inventory_draft");
    }

    function showAutosaveIndicator() {
      const indicator = document.getElementById("autosave-indicator");
      indicator.textContent = "‚úì –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è " + new Date().toLocaleTimeString();
      setTimeout(() => {
        indicator.textContent = "";
      }, 3000);
    }

    // –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –≤–∏—Ö–æ–¥–æ–º
    window.addEventListener("beforeunload", (e) => {
      // –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –≤–∫–ª–∞–¥–∫–∏
      if (currentFridge) {
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ navigator.sendBeacon –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ–≥–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
        const data = JSON.stringify({});
        fetch(`${API_URL}/api/locks/unlock/${currentFridge.fridgeNumber}`, {
          method: "DELETE",
          keepalive: true // –í–∞–∂–ª–∏–≤–æ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –≤–∫–ª–∞–¥–∫–∏
        }).catch(() => {}); // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏
      }
      
      if (hasUnsavedChanges || Object.keys(inventoryData).length > 0) {
        e.preventDefault();
        e.returnValue = "–í–∞—à—ñ –∑–º—ñ–Ω–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤—Ç—Ä–∞—á–µ–Ω—ñ. –í–∏–π—Ç–∏ –≤—Å–µ –æ–¥–Ω–æ?";
        return e.returnValue;
      }
    });
  </script>
  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ: –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π -->
  <div id="locked-modal" class="modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <h2 style="color: #f59e0b; margin-bottom: 10px;">ü´£ –£–ø—Å... —Ç—É—Ç —Ö—Ç–æ—Å—å –≤–∂–µ –≤–Ω–æ—Å–∏—Ç—å –¥–∞–Ω—ñ</h2>
      <p id="locked-info" style="font-size: 1.1em; color: #666; margin-bottom: 25px;"></p>
      <button 
        onclick="forceUnlockAndOpen()" 
        class="save-btn"
        style="width: 100%; font-size: 1.2em; padding: 15px;">
        üîì –í—ñ–¥–∫—Ä–∏—Ç–∏
      </button>
      <button 
        onclick="closeLockModal()" 
        style="margin-top: 10px; background: #6b7280; color: white; border: none; 
               padding: 12px 25px; border-radius: 10px; cursor: pointer; width: 100%;"
        onmouseover="this.style.background='#4b5563'" 
        onmouseout="this.style.background='#6b7280'">
        –ù–∞–∑–∞–¥
      </button>
    </div>
  </div>

</body>
</html>
